前章ではタイトルを付け、ゲームの「開始」と「終了」を明確にしました。
次は、ゲームを面白くする要素として「HP（ヒットポイント）」と「弾の攻撃力」そして「エネミーがダメージを受けた時のアニメーション」「プレイヤーの無敵アニメーション」を実装します。

11.1　HP（ヒットポイント）と攻撃力（power）の実装
-------------------------------------------------------------------------

まずは**Enemy.cs**にヒットポイントを実装します。



Enemy.cs

```cs
using UnityEngine;
using System.Collections;

public class Enemy : MonoBehaviour
{
	// ヒットポイント
	public int hp = 1;
	
	// Spaceshipコンポーネント
	Spaceship spaceship;
	
	IEnumerator Start ()
	{
		
		// Spaceshipコンポーネントを取得
		spaceship = GetComponent<Spaceship> ();
		
		// ローカル座標のY軸のマイナス方向に移動する
		Move (transform.up * -1);
		
		// canShotがfalseの場合、ここでコルーチンを終了させる
		if (spaceship.canShot == false) {
			yield break;
		}
		
		while (true) {
			
			// 子要素を全て取得する
			for (int i = 0; i < transform.childCount; i++) {
				
				Transform shotPosition = transform.GetChild (i);
				
				// ShotPositionの位置/角度で弾を撃つ
				spaceship.Shot (shotPosition);
			}
			
			// shotDelay秒待つ
			yield return new WaitForSeconds (spaceship.shotDelay);
		}
	}
	
	// 機体の移動
	public void Move (Vector2 direction)
	{
		GetComponent<Rigidbody2D>().velocity = direction * spaceship.speed;
	}
	
	void OnTriggerEnter2D (Collider2D c)
	{
		// レイヤー名を取得
		string layerName = LayerMask.LayerToName (c.gameObject.layer);
		
		// レイヤー名がBullet (Player)以外の時は何も行わない
		if (layerName != "Bullet (Player)") return;
		
		// 弾の削除
		Destroy(c.gameObject);
		
		// 爆発
		spaceship.Explosion ();
		
		// エネミーの削除
		Destroy (gameObject);
	}
}
```



次に**Bullet.cs**に攻撃力を実装します。



Bullet.cs

```cs
using UnityEngine;

public class Bullet : MonoBehaviour
{
	// 弾の移動スピード
	public int speed = 10;
	
	// ゲームオブジェクト生成から削除するまでの時間
	public float lifeTime = 1;
	
	// 攻撃力
	public int power = 1;
	
	void Start ()
	{
		// ローカル座標のY軸方向に移動する
		GetComponent<Rigidbody2D>().velocity = transform.up.normalized * speed;
		
		// lifeTime秒後に削除
		Destroy (gameObject, lifeTime);
	}
}
```



### ヒットポイントが0になった時に爆発させる

**Enemy.cs**のOnTriggerEnter2Dメソッド内にヒットポイントを減らしていく処理を実装していきます。
今回はたまの攻撃力の数値でヒットポイントを減らしていきます。



Enemy.cs

```cs
using UnityEngine;
using System.Collections;

public class Enemy : MonoBehaviour
{
	// ヒットポイント
	public int hp = 1;
	
	// Spaceshipコンポーネント
	Spaceship spaceship;
	
	IEnumerator Start ()
	{
		
		// Spaceshipコンポーネントを取得
		spaceship = GetComponent<Spaceship> ();
		
		// ローカル座標のY軸のマイナス方向に移動する
		Move (transform.up * -1);
		
		// canShotがfalseの場合、ここでコルーチンを終了させる
		if (spaceship.canShot == false) {
			yield break;
		}
		
		while (true) {
			
			// 子要素を全て取得する
			for (int i = 0; i < transform.childCount; i++) {
				
				Transform shotPosition = transform.GetChild (i);
				
				// ShotPositionの位置/角度で弾を撃つ
				spaceship.Shot (shotPosition);
			}
			
			// shotDelay秒待つ
			yield return new WaitForSeconds (spaceship.shotDelay);
		}
	}
	
	// 機体の移動
	public void Move (Vector2 direction)
	{
		GetComponent<Rigidbody2D>().velocity = direction * spaceship.speed;
	}
	
	void OnTriggerEnter2D (Collider2D c)
	{
		// レイヤー名を取得
		string layerName = LayerMask.LayerToName (c.gameObject.layer);
		
		// レイヤー名がBullet (Player)以外の時は何も行わない
		if (layerName != "Bullet (Player)") return;
		
		// PlayerBulletのTransformを取得
		Transform playerBulletTransform = c.transform.parent;
		
		// Bulletコンポーネントを取得
		Bullet bullet =  playerBulletTransform.GetComponent<Bullet>();
		
		// ヒットポイントを減らす
		hp = hp - bullet.power;
		
		// 弾の削除
		Destroy(c.gameObject);
		
		// ヒットポイントが0以下であれば
		if(hp <= 0 )
		{
			// 爆発
			spaceship.Explosion ();
			
			// エネミーの削除
			Destroy (gameObject);
		}
	}
}
```



**Waveプレハブ**のEnemyを3つ選択し、HPの値を**10**にします。



![](images/game/11/enemy_hitpoint.png)



ゲームを再生してみましょう。プレイヤーの弾に何発か当たらないとエネミーは爆発しなくなります。

11.2　ダメージを受けた時の表現
------------------------------------------------------



![](images/game/11/damage_enemy.png)



エネミーがダメージを受けたときに、わかりやすく機体の色を赤色にします。

### アニメーター - レイヤーの作成



![新しいレイヤーを作成し、ダメージを受けた時の表現を実装する（完成図）](images/game/11/animator_layer.png)
<br/>図11.1:
新しいレイヤーを作成し、ダメージを受けた時の表現を実装する（完成図）



エネミーには既に**Normal**という「スプライトを切り替えていく」アニメーションがあります。今回はそのNormalアニメーションに、色を変化させるアニメーションを「上書き」する形でダメージを表現します。

#### レイヤーの追加

`Project->Animations->Enemy->Enemy`をダブルクリックし、アニメーターウィンドウを開きます。

レイヤーを追加します。追加した後は、「**NameをDamage
Layer**、**Weightを1**にしてください。





![レイヤーの追加](images/game/11/add_animator_layer.png)
<br/>図11.2: レイヤーの追加





![レイヤー名とウェイトの変更](images/game/11/rename_layername_and_change_weight.png)
<br/>図11.3: レイヤー名とウェイトの変更





<br/>図11.3にBlendingという項目があり、これが**Override**で**Weightが1**であれば「他のレイヤーで同じ色のアニメーションをしている場合でも、Damage
Layerの色のアニメーションを使用する」事になります。

#### Damageアニメーションの作成

**Enemy**フォルダ上で右クリックし、`Create → Animation`を選択してアニメーションのアセットを作成します。名前は**Damage**としてください。



![フォルダを右クリックしてメニューを選択するとフォルダ下に作成される](images/game/11/create_damage_animation.png)
<br/>図11.4:
フォルダを右クリックしてメニューを選択するとフォルダ下に作成される



作成したらアニメーターに登録するためにDamageアニメーションをアニメーターの**Damage
Layer**上にドラッグ＆ドロップします。



![](images/game/11/drag_damage_animation.png)



次はアニメーションを作成していきます。一度**Enemyのプレハブ**をシーン上へドラッグ＆ドロップしてください。



![](images/game/11/drop_enemy.png)



**Enemy**ゲームオブジェクトを選択しながら、**Window →
Animation**を選択し、Animationウィンドウを開きます。
開いたらNormalアニメーションが選択されているので、Damageアニメーションへ変更します。



![](images/game/11/select_damage_animation.png)



アニメーションを行うプロパティを登録します。`Add Property`ボタンで**Sprite
Renderer → Color**を追加してください。
Unity5.5現在では`Add Curve`ボタンは`Add Property`ボタンになっています。


![](images/game/11/add_sprite_color_curve.png)



するとデフォルトでKeyが2箇所、設定されているので右側のKeyを削除します。Keyを右クリックして**Delete
Keys**を選択してください。



![](images/game/11/delete_key.png)



更に２つの操作を行います。
まずは、0フレーム目にあるKeyを5フレーム目に移動させます。一番上のKeyをドラッグして5フレームまで移動させてください。フレーム数の確認は左上で確認することが出来ます。
次に色の情報を変更します。**Color.rを1**、**Color.gを0**、**Color.bを0.6**、**Color.aを1**にしてください。



![](images/game/11/move_key_and_change_color_property.png)



インスペクターのプレビューでエネミーが赤色になっているはずです。



![](images/game/11/pprite_preview.png)



#### トリガーの作成

ダメージを受けた時のみエネミーを赤色にするため、**トリガー**という機能を使います。
まずアニメーター上で**空のステート**を作成します。アニメーターウィンドウ上で右クリックをして、`Create State → Empty`を選択してください。



![](images/game/11/create_state_empty.png)



名前を**Dummy**とします。ステートの名前を変更するにはインスペクター上で行います。ステートをクリックしてインスペクターを表示させましょう。



![](images/game/11/rename_dummy_state.png)



次にDummyをデフォルトステートとします。Dummyステート上で右クリックして`Set As Default`を選択してください。デフォルトステートはゲーム再生直後に再生されるステートのことを指します。こうすることによって、ゲーム再生時、Damage
LayerではDummyステートが再生され、**何もアニメーションを行わない**状態になります。



![](images/game/11/set_as_default.png)



次は何も行わない状態からトリガーによって**Damageアニメーションを再生 →
何も行わない状態 →
Damageアニメーション...**と繰り返し状態の遷移を行うようにします。
Dummy上で右クリックし、**Make Transition**を選択します。



![](images/game/11/make_transition.png)



カーソルに矢印が追従するのでDamageステート上でクリックします。そうするとDummyステートからDamageステートへ**何らかの条件で遷移する**事ができるようになります。



![](images/game/11/assign_transition_1.png)



同じようにDamageステートからDummyステートへのTransitionも作成しましょう。



![](images/game/11/assign_transition_2.png)



次にトリガーを作成します。アニメーターウィンドウの左上にあるParametersタブを押してParametersに切り替え、＋ボタンを押して**Trigger**を選択してください。



![](images/game/11/create_trigger.png)



名前を**Damage**とします。



![](images/game/11/rename_damage_trigger.png)



DummyステートからDamageステートへのTransitionをクリックし、表示されたインスペクターのConditionsを＋を押して追加し、Damageへと変更します。さらに、Has Exit Timeのチェックを外しておきましょう。DamageステートからDummyステートへのTransitionはそのままにしておきましょう。





![ConditionsをDamageへ](images/game/11/set_damage_trigger.png)
<br/>図11.5: ConditionsをDamageへ





![そのまま変更なし](images/game/11/damage_dummy_transition.png)
<br/>図11.6: そのまま変更なし





### スクリプトからトリガーのセット

ダメージを受けた時に「トリガーをセット」してダメージアニメーションを再生させます。
まずは**Spaceship.cs**にAnimatorコンポーネントを取得するメソッドを追加します。



Spaceship.cs

```cs
using UnityEngine;

[RequireComponent(typeof(Rigidbody2D), typeof(Animator))]
public class Spaceship : MonoBehaviour
{
    // 移動スピード
    public float speed;

    // 弾を撃つ間隔
    public float shotDelay;

    // 弾のPrefab
    public GameObject bullet;

    // 弾を撃つかどうか
    public bool canShot;

    // 爆発のPrefab
    public GameObject explosion;

    // アニメーターコンポーネント
    private Animator animator;

    void Start ()
    {
        // アニメーターコンポーネントを取得
        animator = GetComponent<Animator> ();
    }

    // 爆発の作成
    public void Explosion ()
    {
        Instantiate (explosion, transform.position, transform.rotation);
    }

    // 弾の作成
    public void Shot (Transform origin)
    {
        Instantiate (bullet, origin.position, origin.rotation);
    }

    // アニメーターコンポーネントの取得
    public Animator GetAnimator()
    {
        return animator;
    }
}
```



OnTriggerEnter2Dメソッド内にある、エネミーのHPをチェックしている部分を「HPが0以上であればDamageトリガーをセットする」ようにします。



Enemy.cs

```cs
using UnityEngine;
using System.Collections;

public class Enemy : MonoBehaviour
{
	// ヒットポイント
	public int hp = 1;
	
	// Spaceshipコンポーネント
	Spaceship spaceship;
	
	IEnumerator Start ()
	{
		
		// Spaceshipコンポーネントを取得
		spaceship = GetComponent<Spaceship> ();
		
		// ローカル座標のY軸のマイナス方向に移動する
		Move (transform.up * -1);
		
		// canShotがfalseの場合、ここでコルーチンを終了させる
		if (spaceship.canShot == false) {
			yield break;
		}
		
		while (true) {
			
			// 子要素を全て取得する
			for (int i = 0; i < transform.childCount; i++) {
				
				Transform shotPosition = transform.GetChild (i);
				
				// ShotPositionの位置/角度で弾を撃つ
				spaceship.Shot (shotPosition);
			}
			
			// shotDelay秒待つ
			yield return new WaitForSeconds (spaceship.shotDelay);
		}
	}
	
	// 機体の移動
	public void Move (Vector2 direction)
	{
		GetComponent<Rigidbody2D>().velocity = direction * spaceship.speed;
	}
	
	void OnTriggerEnter2D (Collider2D c)
	{
		// レイヤー名を取得
		string layerName = LayerMask.LayerToName (c.gameObject.layer);
		
		// レイヤー名がBullet (Player)以外の時は何も行わない
		if (layerName != "Bullet (Player)") return;
		
		// PlayerBulletのTransformを取得
		Transform playerBulletTransform = c.transform.parent;
		
		// Bulletコンポーネントを取得
		Bullet bullet =  playerBulletTransform.GetComponent<Bullet>();
		
		// ヒットポイントを減らす
		hp = hp - bullet.power;
		
		// 弾の削除
		Destroy(c.gameObject);
		
		// ヒットポイントが0以下であれば
		if(hp <= 0 )
		{
			// 爆発
			spaceship.Explosion ();
			
			// エネミーの削除
			Destroy (gameObject);
			
		}else{
			
			spaceship.GetAnimator().SetTrigger("Damage");
			
		}
	}
}
```



最後にEnemyゲームオブジェクトを削除して、ゲームを再生してみましょう。
弾が当たった時にエネミーが赤色になりました。ですが徐々に赤色になり、徐々に元の色に戻るアニメーション（フェード）になっています。
もう一度、アニメーターのTransitionのインスペクターを確認しましょう。
<br/>図11.7と図11.8のようにDummyステートからDamageステートへのTransitionのFadeのつまみを限りなく近づけてみましょう。





![](images/game/11/before_crossfade_1.png)
<br/>図11.7:





![](images/game/11/after_crossfade_1.png)
<br/>図11.8:





DamageステートからDummyステートへのTransitionも同じ設定を行います。ただし、**Exit
Timeを1**へ設定してください。





![](images/game/11/before_crossfade_2.png)
<br/>図11.9:





![](images/game/11/after_crossfade_2.png)
<br/>図11.10:





ゲームを再生してみてください。ダメージを受けた時、瞬間的に赤色になるはずです。

11.3　プレイヤーの無敵時間
--------------------------------------------------

ゲーム開始時にプレイヤーを点滅させ、無敵の状態を実装します。
実装方法はエネミーのダメージアニメーションの実装と同じです。

### レイヤーの追加

Playerアニメーターコントローラーを**ダブルクリック**してAnimatorウィンドウを開きます。



![](images/game/11/player_animator.png)



**Invincible
Layer**を追加します。**Weightを1**にするのを忘れないで下さい。



![](images/game/11/add_invincible_layer.png)



### アニメーションの作成

Playerプレハブをシーン上へドラッグ＆ドロップしてください。



![](images/game/11/drop_player.png)



次にアニメーションのアセットを作成します。**Player**フォルダを選択し右クリックをして、`Create → Animation`を選択しください。



![](images/game/11/create_animation_player.png)



作成されたアニメーションのアセット名は**Invincible**とします。



![](images/game/11/create_invincible_animation.png)



**Invincible**アニメーションの**Loop Time**にチェックを入れてください。



![](images/game/11/check_invincible_loop.png)



**Invincible
Layer**に**Invincible**アニメーションをドラッグ＆ドロップし、**Invincible**ステートを作成します。



![](images/game/11/drop_invincible_animation.png)



`Create State → Empty`で**Dummy**ステートを作成し、**Invincible**ステートから**Dummy**ステートへのTransitionを作成します。
Transitionの**Exit
Timeは3**にしてください。これは3回**Invincible**アニメーションをループさせる処理になります。



![](images/game/11/create_dummy_and_transition.png)



次にアニメーションを作成していきます。**Player**ゲームオブジェクトを選択しながらAnimationウィンドウを開き、**Invincible**アニメーションを選択してください。



![](images/game/11/select_invincible_animation.png)



`Add Curve`ボタンで**Sprite Renderer → Enabled**と**Box
Collider 2D → Enabled**の２つを追加してください





![](images/game/11/add_sprite_renderer_enable_player.png)
<br/>図11.11:





![](images/game/11/add_boxcolider2d_enable_player.png)
<br/>図11.12:





0フレーム目はオフに、60フレーム目はオンにします。ただし、**Box Collider
2Dのキーは削除**してください。**Invincible**アニメーション再生中にコライダーを無効化し、当たり判定を発生させないことで無敵を実現させます。





![](images/game/11/invincible_0_frame.png)
<br/>図11.13:





![](images/game/11/invincible_60_frame.png)
<br/>図11.14:





これを交互に60フレームまで「オフ、オン、オフ、オン...」というようにキーを打ち込んでください。この作業を楽にする方法として、キーのコピー＆ペーストがあります。キーを選択し`⌘(Ctrl)+C`でコピーしたら**0:10**の文字があるところをマウスでクリックし`⌘(Ctrl)+V`でペーストしてください。



![](images/game/11/invincible_0_60_frame.png)



最後に**Player**ゲームオブジェクトを削除して、ゲームを再生してみてください。ゲームを開始すると点滅の無敵状態が３秒間続きます。

### 第11回終わり

今回はここで終了です。つまずいてしまった方はプロジェクトファイルをダウンロードして新たな気持ちで次の回へ進みましょう。

[今回のプロジェクトファイルをダウンロード](project/game_11_ShootingGame.zip)
